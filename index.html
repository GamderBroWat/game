<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mario Mobile</title>

<meta name="viewport"
content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#5c94fc;
  touch-action:none;
}
canvas{display:block}

/* TOUCH CONTROLS */
.controls{
  position:fixed;
  bottom:10px;
  left:0;
  right:0;
  height:120px;
  pointer-events:none;
}
.btn{
  pointer-events:auto;
  position:absolute;
  width:70px;
  height:70px;
  border-radius:50%;
  background:rgba(0,0,0,.4);
  color:white;
  font-size:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
.btn:active{background:rgba(255,255,255,.4)}

#left{left:20px;bottom:20px}
#right{left:110px;bottom:20px}
#jump{right:110px;bottom:20px}
#shoot{right:20px;bottom:20px}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div class="controls">
  <div class="btn" id="left">◀</div>
  <div class="btn" id="right">▶</div>
  <div class="btn" id="jump">⤒</div>
  <div class="btn" id="shoot">●</div>
</div>

<script>
/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const DPR = window.devicePixelRatio || 1;

let FLOOR;

/* ================= ASSETS ================= */
const playerImg = new Image();
const milkImg   = new Image();
const enemyImg  = new Image();
const bulletImg = new Image();
const eatSound  = new Audio("voice.mp3");

let assetsLoaded = false;
function loadAssets(){
  if(assetsLoaded) return;
  playerImg.crossOrigin="anonymous";
  milkImg.crossOrigin="anonymous";
  enemyImg.crossOrigin="anonymous";
  bulletImg.crossOrigin="anonymous";

  playerImg.src="photo.png";
  milkImg.src="milk.png";
  enemyImg.src="doctor.png";
  bulletImg.src="bez.png";
  eatSound.load();
  assetsLoaded = true;
}

/* ================= PLAYER ================= */
const player = {
  x: 100,
  size: 150,        // уменьшен в 2 раза
  y: 0,
  vx: 0,
  vy: 0,
  speed: 5,
  jump: -18,
  onGround: false
};

/* ================= RESIZE ================= */
function resize(){
  canvas.width  = innerWidth * DPR;
  canvas.height = innerHeight * DPR;
  canvas.style.width  = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
  ctx.setTransform(DPR,0,0,DPR,0,0);

  FLOOR = innerHeight * 0.85;

  // ГАРАНТИРОВАННО СТАВИМ ИГРОКА НА ЗЕМЛЮ
  player.y = FLOOR - player.size;
  player.vy = 0;
  player.onGround = true;
}
addEventListener("resize", resize);

/* ================= INPUT ================= */
const input = {left:false,right:false,jump:false,shoot:false};
function bind(id,key){
  const el=document.getElementById(id);
  el.addEventListener("touchstart",e=>{
    e.preventDefault();
    input[key]=true;
  },{passive:false});
  el.addEventListener("touchend",()=>input[key]=false);
}
bind("left","left");
bind("right","right");
bind("jump","jump");
bind("shoot","shoot");

/* ================= OBJECTS ================= */
const milks = [];
const bullets = [];
let enemy = null;
let lastShot = 0;

/* ================= SPAWN ================= */
setInterval(()=>{
  milks.push({
    x: innerWidth + 100,
    y: FLOOR - 130,
    size: 100,
    vx: -3
  });
},5000);

function spawnEnemy(){
  enemy = {
    x: innerWidth + 200,
    y: FLOOR - 120,
    size: 120,
    vx: -2,
    hp: 3,
    alive: true
  };
}
spawnEnemy();
setInterval(spawnEnemy,12000);

/* ================= GAME ================= */
const GRAVITY = 0.8;

function update(){
  player.vx = 0;
  if(input.left)  player.vx = -player.speed;
  if(input.right) player.vx =  player.speed;

  if(input.jump && player.onGround){
    player.vy = player.jump;
    player.onGround = false;
  }

  if(input.shoot && performance.now() - lastShot > 1000){
    bullets.push({
      x: player.x + player.size,
      y: player.y + player.size/2 - 20,
      size: 80,
      vx: 4
    });
    lastShot = performance.now();
  }

  player.vy += GRAVITY;
  player.x  += player.vx;
  player.y  += player.vy;

  if(player.y + player.size >= FLOOR){
    player.y = FLOOR - player.size;
    player.vy = 0;
    player.onGround = true;
  }

  milks.forEach(m => m.x += m.vx);
  for(let i=milks.length-1;i>=0;i--){
    if(collide(player,milks[i])){
      eatSound.currentTime=0;
      eatSound.play().catch(()=>{});
      milks.splice(i,1);
    }
  }

  if(enemy && enemy.alive) enemy.x += enemy.vx;

  bullets.forEach(b=>b.x+=b.vx);
  for(let i=bullets.length-1;i>=0;i--){
    if(enemy && enemy.alive && collide(bullets[i],enemy)){
      enemy.hp--;
      bullets.splice(i,1);
      if(enemy.hp<=0) enemy.alive=false;
    }
  }
}

/* ================= COLLISION ================= */
function collide(a,b){
  return a.x < b.x + b.size &&
         a.x + a.size > b.x &&
         a.y < b.y + b.size &&
         a.y + a.size > b.y;
}

/* ================= DRAW ================= */
function draw(){
  ctx.fillStyle="#5c94fc";
  ctx.fillRect(0,0,innerWidth,innerHeight);

  ctx.fillStyle="#3cb043";
  ctx.fillRect(0,FLOOR,innerWidth,innerHeight);

  ctx.imageSmoothingEnabled=false;
  ctx.drawImage(playerImg,player.x,player.y,player.size,player.size);

  milks.forEach(m=>{
    ctx.drawImage(milkImg,m.x,m.y,m.size,m.size);
  });

  if(enemy && enemy.alive){
    ctx.drawImage(enemyImg,enemy.x,enemy.y,enemy.size,enemy.size);
    ctx.fillStyle="red";
    ctx.fillRect(enemy.x,enemy.y-15,enemy.size,8);
    ctx.fillStyle="lime";
    ctx.fillRect(enemy.x,enemy.y-15,enemy.size*(enemy.hp/3),8);
  }

  bullets.forEach(b=>{
    ctx.drawImage(bulletImg,b.x,b.y,b.size,b.size);
  });
}

/* ================= LOOP ================= */
let started=false;
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

function startGame(){
  if(started) return;
  loadAssets();
  resize();
  started=true;
  loop();
}

document.addEventListener("touchstart", startGame, {once:true});
if(innerWidth > innerHeight) startGame();

</script>
</body>
</html>
