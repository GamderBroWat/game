<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Bump Multiplayer</title>
    <style>
        :root {
            --bg: #0a0a0c;
            --accent: #00f2ff;
        }
        * { box-sizing: border-box; touch-action: none; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* Экран авторизации */
        #auth-screen {
            position: fixed; z-index: 10; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(10, 10, 12, 0.95);
        }
        input {
            padding: 15px; border-radius: 25px; border: 2px solid var(--accent);
            background: transparent; color: white; font-size: 1.2rem; text-align: center;
            margin-bottom: 20px; outline: none;
        }
        button {
            padding: 15px 40px; border-radius: 25px; border: none;
            background: var(--accent); color: black; font-weight: bold;
            font-size: 1.1rem; cursor: pointer;
        }

        /* Игровой интерфейс */
        #game-ui {
            position: absolute; top: 20px; left: 20px; pointer-events: none;
            text-shadow: 0 0 10px rgba(0,242,255,0.5);
        }
        canvas { display: block; background: radial-gradient(circle, #1a1a2e 0%, #0a0a0c 100%); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color: var(--accent); letter-spacing: 5px;">NEON BUMP</h1>
        <input type="text" id="nickname" placeholder="Твой никнейм" maxlength="12">
        <button onclick="startGame()">ИГРАТЬ</button>
        <p style="font-size: 0.8rem; opacity: 0.6; margin-top: 20px;">Нажимай на экран, чтобы двигаться</p>
    </div>

    <div id="game-ui">
        <div id="score">Очки: 0</div>
        <div id="online">В сети: 0</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, onDisconnect, update, remove } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Конфигурация (Публичная тестовая БД)
        const firebaseConfig = {
            databaseURL: "https://multiplayer-demo-64b54-default-rtdb.europe-west1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const authScreen = document.getElementById('auth-screen');
        
        let playerId;
        let playerRef;
        let players = {};
        let myData = { x: 0, y: 0, score: 0, color: '', name: '' };
        let targetPos = { x: 0, y: 0 };

        // Инициализация размеров
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        window.startGame = function() {
            const nick = document.getElementById('nickname').value.trim();
            if(!nick) return alert("Введите имя!");

            playerId = 'p_' + Math.random().toString(36).substr(2, 9);
            myData = {
                id: playerId,
                name: nick,
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                score: 0,
                color: `hsl(${Math.random() * 360}, 70%, 60%)`
            };

            playerRef = ref(db, 'players/' + playerId);
            set(playerRef, myData);
            onDisconnect(playerRef).remove();

            authScreen.style.display = 'none';
            targetPos = { x: myData.x, y: myData.y };

            // Слушаем всех игроков
            onValue(ref(db, 'players'), (snapshot) => {
                players = snapshot.val() || {};
                document.getElementById('online').innerText = `В сети: ${Object.keys(players).length}`;
            });

            gameLoop();
        };

        // Управление (Touch и Mouse)
        const handleInput = (e) => {
            if(!playerId) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            targetPos.x = clientX;
            targetPos.y = clientY;
        };

        window.addEventListener('mousedown', handleInput);
        window.addEventListener('touchstart', handleInput);

        function gameLoop() {
            // Плавное движение игрока (Interpolation)
            myData.x += (targetPos.x - myData.x) * 0.05;
            myData.y += (targetPos.y - myData.y) * 0.05;

            // Обновление позиции в БД (не чаще 30 раз в сек для экономии трафика)
            update(playerRef, { x: myData.x, y: myData.y });

            // Отрисовка
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            Object.values(players).forEach(p => {
                // Тень/Свечение
                ctx.shadowBlur = 15;
                ctx.shadowColor = p.color;
                
                // Тело игрока
                ctx.beginPath();
                ctx.arc(p.x, p.y, 20 + (p.score || 0), 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.closePath();
                
                // Имя
                ctx.shadowBlur = 0;
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.fillText(p.name, p.x, p.y - 35);
            });

            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
