<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">

<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Arrow World</title>

<style>
*{
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  touch-action:none;
}

html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  background:#0f1115;
  color:white;
  font-family:system-ui,sans-serif;
}

#login{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:14px;
}

input,button{
  font-size:22px;
  padding:14px 18px;
  border-radius:16px;
  border:none;
}

button{
  background:#5eead4;
  font-weight:700;
}

canvas{display:none}

#controls{
  position:absolute;
  bottom:28px;
  left:50%;
  transform:translateX(-50%);
  display:grid;
  grid-template:repeat(3,90px)/repeat(3,90px);
  gap:12px;
  display:none;
}

.ctrl{
  background:rgba(255,255,255,.22);
  border-radius:24px;
  font-size:36px;
  display:flex;
  align-items:center;
  justify-content:center;
}
</style>
</head>

<body>

<div id="login">
  <h2>Arrow World</h2>
  <input id="name" placeholder="–ù–∏–∫">
  <button id="play">–û–ö</button>
</div>

<canvas id="game"></canvas>

<div id="controls">
  <div></div><div class="ctrl" data="up">‚¨ÜÔ∏è</div><div></div>
  <div class="ctrl" data="left">‚¨ÖÔ∏è</div><div></div><div class="ctrl" data="right">‚û°Ô∏è</div>
  <div></div><div class="ctrl" data="down">‚¨áÔ∏è</div><div></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// üö´ –£–ë–ò–ô–°–¢–í–û –ó–£–ú–ê (iOS SAFE)
document.addEventListener('gesturestart',e=>e.preventDefault());
document.addEventListener('gesturechange',e=>e.preventDefault());
document.addEventListener('gestureend',e=>e.preventDefault());
document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});

// üî• FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyCnJQPTInx6HF6KarGXBYGQslKanlxLl7M",
  authDomain:"arrowgame-94ba7.firebaseapp.com",
  databaseURL:"https://arrowgame-94ba7-default-rtdb.firebaseio.com",
  projectId:"arrowgame-94ba7"
});

const db=firebase.database();
firebase.auth().signInAnonymously();

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let W,H,DPR=window.devicePixelRatio||1;
let me=null;
let players={};
let move={up:0,down:0,left:0,right:0};
let myName="";

// üéÆ –ö–ù–û–ü–ö–ê –†–ê–ë–û–¢–ê–ï–¢ –í–°–ï–ì–î–ê
document.getElementById("play").onclick=()=>{
  const n=document.getElementById("name").value.trim();
  if(!n)return;
  myName=n;
  tryStart();
};

// üîë –ñ–î–Å–ú –ê–í–¢–û–†–ò–ó–ê–¶–ò–Æ
firebase.auth().onAuthStateChanged(user=>{
  if(user) tryStart();
});

function tryStart(){
  if(me || !firebase.auth().currentUser || !myName) return;

  document.getElementById("login").style.display="none";
  canvas.style.display="block";
  document.getElementById("controls").style.display="grid";

  resize();

  const uid=firebase.auth().currentUser.uid;
  me={
    id:uid,
    name:myName,
    x:0.5,
    y:0.5,
    color:`hsl(${Math.random()*360},70%,60%)`
  };

  const ref=db.ref("players/"+uid);
  ref.set(me);
  ref.onDisconnect().remove();
  addEventListener("beforeunload",()=>ref.remove());

  db.ref("players").on("value",s=>{
    players=s.val()||{};
  });

  setInterval(update,50);
  loop();
}

// üìê CANVAS
function resize(){
  W=innerWidth;
  H=innerHeight;
  canvas.width=W*DPR;
  canvas.height=H*DPR;
  canvas.style.width=W+"px";
  canvas.style.height=H+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener("resize",resize);

// üéÆ –£–ü–†–ê–í–õ–ï–ù–ò–ï
document.querySelectorAll(".ctrl").forEach(b=>{
  const d=b.dataset;
  b.ontouchstart=b.onmousedown=()=>move[b.getAttribute("data")]=1;
  b.ontouchend=b.onmouseup=()=>move[b.getAttribute("data")]=0;
});

// üß† –õ–û–ì–ò–ö–ê
function update(){
  if(!me)return;
  const s=0.02;
  if(move.up)me.y-=s;
  if(move.down)me.y+=s;
  if(move.left)me.x-=s;
  if(move.right)me.x+=s;
  me.x=Math.max(.05,Math.min(.95,me.x));
  me.y=Math.max(.05,Math.min(.95,me.y));
  db.ref("players/"+me.id).update({x:me.x,y:me.y});
}

// üé® –†–ï–ù–î–ï–†
function loop(){
  ctx.clearRect(0,0,W,H);
  ctx.textAlign="center";
  ctx.font="22px system-ui";

  for(const id in players){
    const p=players[id];
    if(!p||!p.name)continue;

    const x=W*p.x;
    const y=H*p.y;

    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(x,y,30,0,Math.PI*2);
    ctx.fill();

    ctx.strokeStyle="#000";
    ctx.lineWidth=4;
    ctx.strokeText(p.name,x,y-46);
    ctx.fillStyle="#fff";
    ctx.fillText(p.name,x,y-46);
  }

  requestAnimationFrame(loop);
}
</script>

</body>
</html>