// ... (—Å—Ç–∏–ª–∏ –∏ HTML —Ç–µ –∂–µ) ...

// üß† –õ–û–ì–ò–ö–ê –ò –°–û–°–¢–û–Ø–ù–ò–ï
let lastSentPos = { x: 0, y: 0 }; // –ß—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –≤ –ë–î

function update() {
  if (!me) return;
  
  let dx = 0;
  let dy = 0;
  const s = 0.015;

  if (move.up) dy -= s;
  if (move.down) dy += s;
  if (move.left) dx -= s;
  if (move.right) dx += s;

  if (dx !== 0 || dy !== 0) {
    me.x = Math.max(0.05, Math.min(0.95, me.x + dx));
    me.y = Math.max(0.05, Math.min(0.95, me.y + dy));

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ë–î —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (—Å –ø–æ—Ä–æ–≥–æ–º)
    if (Math.abs(me.x - lastSentPos.x) > 0.001 || Math.abs(me.y - lastSentPos.y) > 0.001) {
      db.ref("players/" + me.id).update({ x: me.x, y: me.y });
      lastSentPos = { x: me.x, y: me.y };
    }
  }
}

// üéÆ –£–õ–£–ß–®–ï–ù–ù–´–ï –ö–û–ù–¢–†–û–õ–õ–ï–†–´
document.querySelectorAll(".ctrl").forEach(b => {
  const d = b.dataset.dir;
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É Touch –∏ Mouse –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
  const start = (e) => { e.preventDefault(); move[d] = 1; };
  const end = (e) => { e.preventDefault(); move[d] = 0; };
  
  b.addEventListener('mousedown', start);
  b.addEventListener('touchstart', start);
  // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–Ω—è—Ç–∏–µ –Ω–∞–∂–∞—Ç–∏—è, —á—Ç–æ–±—ã –ø–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ "–∑–∞–ª–∏–ø–∞–ª"
  window.addEventListener('mouseup', () => move[d] = 0);
  window.addEventListener('touchend', () => move[d] = 0);
});

// üé® –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –†–ï–ù–î–ï–†
function loop() {
  ctx.clearRect(0, 0, W, H);
  
  // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É –¥–ª—è –æ—â—É—â–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
  ctx.strokeStyle = "rgba(255,255,255,0.05)";
  for(let i=0; i<W; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,H); ctx.stroke(); }
  for(let i=0; i<H; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(W,i); ctx.stroke(); }

  ctx.textAlign = "center";
  ctx.font = "bold 16px system-ui";

  for (const id in players) {
    const p = players[id];
    if (!p || p.x === undefined) continue;

    // –ü–ª–∞–≤–Ω–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ (–ø—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è)
    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –Ω–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å lerp, –Ω–æ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ö–≤–∞—Ç–∏—Ç –∏ —ç—Ç–æ–≥–æ
    const x = W * p.x;
    const y = H * p.y;

    // –¢–µ–ª–æ –∏–≥—Ä–æ–∫–∞
    ctx.fillStyle = p.color || '#fff';
    ctx.beginPath();
    ctx.arc(x, y, 20, 0, Math.PI * 2);
    ctx.fill();
    
    // –û–±–≤–æ–¥–∫–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
    ctx.strokeStyle = "white";
    ctx.lineWidth = 2;
    ctx.stroke();

    // –ù–∏–∫–Ω–µ–π–º
    ctx.fillStyle = "white";
    ctx.shadowBlur = 4;
    ctx.shadowColor = "black";
    ctx.fillText(p.name, x, y - 35);
    ctx.shadowBlur = 0;
  }

  requestAnimationFrame(loop);
}
